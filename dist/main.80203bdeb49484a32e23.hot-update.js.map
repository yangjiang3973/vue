{"version":3,"sources":["file:////Users/yangjiang/dev/learn/vue/src/watcher.js","file:///webpack/runtime/getFullHash"],"names":["_","require","config","Observer","expParser","batcher","uid","Watcher","vm","expression","cb","options","_watcherList","push","cbs","id","active","deep","user","deps","Object","create","filters","readFilters","read","writeFilters","write","res","parse","twoWay","getter","get","setter","set","value","p","prototype","addDep","dep","newDeps","addSub","beforeGet","call","e","warnExpressionErrors","warn","traverse","applyFilters","afterGet","target","removeSub","update","async","debug","run","Array","isArray","oldValue","i","l","length","removed","addCb","removeCb","indexOf","splice","teardown","_isBeingDestroyed","list","obj","key","val","isObject","module","exports"],"mappings":";;;;;;;;;;;AAAA,IAAIA,CAAC,GAAGC,mBAAO,CAAC,mCAAD,CAAf;;AACA,IAAIC,MAAM,GAAGD,mBAAO,CAAC,iCAAD,CAApB;;AACA,IAAIE,QAAQ,GAAGF,mBAAO,CAAC,2CAAD,CAAtB;;AACA,IAAIG,SAAS,GAAGH,mBAAO,CAAC,yDAAD,CAAvB;;AACA,IAAII,OAAO,GAAGJ,mBAAO,CAAC,mCAAD,CAArB;;AACA,IAAIK,GAAG,GAAG,CAAV;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,SAASC,OAAT,CAAiBC,EAAjB,EAAqBC,UAArB,EAAiCC,EAAjC,EAAqCC,OAArC,EAA8C;AAC1C,OAAKH,EAAL,GAAUA,EAAV;;AACAA,IAAE,CAACI,YAAH,CAAgBC,IAAhB,CAAqB,IAArB;;AACA,OAAKJ,UAAL,GAAkBA,UAAlB;AACA,OAAKK,GAAL,GAAW,CAACJ,EAAD,CAAX;AACA,OAAKK,EAAL,GAAU,EAAET,GAAZ,CAL0C,CAKzB;;AACjB,OAAKU,MAAL,GAAc,IAAd;AACAL,SAAO,GAAGA,OAAO,IAAI,EAArB;AACA,OAAKM,IAAL,GAAY,CAAC,CAACN,OAAO,CAACM,IAAtB;AACA,OAAKC,IAAL,GAAY,CAAC,CAACP,OAAO,CAACO,IAAtB;AACA,OAAKC,IAAL,GAAYC,MAAM,CAACC,MAAP,CAAc,IAAd,CAAZ,CAV0C,CAW1C;AACA;AACA;AACA;;AACA,MAAIV,OAAO,CAACW,OAAZ,EAAqB;AACjB,SAAKC,WAAL,GAAmBZ,OAAO,CAACW,OAAR,CAAgBE,IAAnC;AACA,SAAKC,YAAL,GAAoBd,OAAO,CAACW,OAAR,CAAgBI,KAApC;AACH,GAlByC,CAmB1C;;;AACA,MAAIC,GAAG,GAAGvB,SAAS,CAACwB,KAAV,CAAgBnB,UAAhB,EAA4BE,OAAO,CAACkB,MAApC,CAAV,CApB0C,CAoBa;;AACvD,OAAKC,MAAL,GAAcH,GAAG,CAACI,GAAlB;AACA,OAAKC,MAAL,GAAcL,GAAG,CAACM,GAAlB;AACA,OAAKC,KAAL,GAAa,KAAKH,GAAL,EAAb,CAvB0C,CAuBjB;AAC5B;;AAED,IAAII,CAAC,GAAG5B,OAAO,CAAC6B,SAAhB;AAEA;AACA;AACA;AACA;AACA;AAEA;;AACAD,CAAC,CAACE,MAAF,GAAW,UAAUC,GAAV,EAAe;AACtB,MAAIvB,EAAE,GAAGuB,GAAG,CAACvB,EAAb;;AACA,MAAI,CAAC,KAAKwB,OAAL,CAAaxB,EAAb,CAAL,EAAuB;AACnB,SAAKwB,OAAL,CAAaxB,EAAb,IAAmBuB,GAAnB;;AACA,QAAI,CAAC,KAAKnB,IAAL,CAAUJ,EAAV,CAAL,EAAoB;AAChB,WAAKI,IAAL,CAAUJ,EAAV,IAAgBuB,GAAhB;AACAA,SAAG,CAACE,MAAJ,CAAW,IAAX;AACH;AACJ;AACJ,CATD;AAWA;AACA;AACA;;;AAEAL,CAAC,CAACJ,GAAF,GAAQ,YAAY;AAChB,OAAKU,SAAL,GADgB,CACE;;AAClB,MAAIjC,EAAE,GAAG,KAAKA,EAAd;AACA,MAAI0B,KAAJ;;AACA,MAAI;AACAA,SAAK,GAAG,KAAKJ,MAAL,CAAYY,IAAZ,CAAiBlC,EAAjB,EAAqBA,EAArB,CAAR,CADA,CACkC;AACrC,GAFD,CAEE,OAAOmC,CAAP,EAAU;AACR,QAAIzC,MAAM,CAAC0C,oBAAX,EAAiC;AAC7B5C,OAAC,CAAC6C,IAAF,CACI,uCACI,KAAKpC,UADT,GAEI,SAFJ,GAGIkC,CAJR;AAMH;AACJ,GAfe,CAgBhB;AACA;;;AACA,MAAI,KAAK1B,IAAT,EAAe;AACX6B,YAAQ,CAACZ,KAAD,CAAR;AACH;;AACDA,OAAK,GAAGlC,CAAC,CAAC+C,YAAF,CAAeb,KAAf,EAAsB,KAAKX,WAA3B,EAAwCf,EAAxC,CAAR;AACA,OAAKwC,QAAL,GAtBgB,CAsBC;;AACjB,SAAOd,KAAP;AACH,CAxBD;AA0BA;AACA;AACA;AACA;AACA;;;AAEAC,CAAC,CAACF,GAAF,GAAQ,UAAUC,KAAV,EAAiB;AACrB,MAAI1B,EAAE,GAAG,KAAKA,EAAd;AACA0B,OAAK,GAAGlC,CAAC,CAAC+C,YAAF,CAAeb,KAAf,EAAsB,KAAKT,YAA3B,EAAyCjB,EAAzC,EAA6C,KAAK0B,KAAlD,CAAR;;AACA,MAAI;AACA,SAAKF,MAAL,CAAYU,IAAZ,CAAiBlC,EAAjB,EAAqBA,EAArB,EAAyB0B,KAAzB;AACH,GAFD,CAEE,OAAOS,CAAP,EAAU;AACR,QAAIzC,MAAM,CAAC0C,oBAAX,EAAiC;AAC7B5C,OAAC,CAAC6C,IAAF,CACI,mCACI,KAAKpC,UADT,GAEI,SAFJ,GAGIkC,CAJR;AAMH;AACJ;AACJ,CAfD;AAiBA;AACA;AACA;;;AAEAR,CAAC,CAACM,SAAF,GAAc,YAAY;AACtBtC,UAAQ,CAAC8C,MAAT,GAAkB,IAAlB;AACA,OAAKV,OAAL,GAAe,EAAf;AACH,CAHD;AAKA;AACA;AACA;;;AAEAJ,CAAC,CAACa,QAAF,GAAa,YAAY;AACrB7C,UAAQ,CAAC8C,MAAT,GAAkB,IAAlB;;AACA,OAAK,IAAIlC,EAAT,IAAe,KAAKI,IAApB,EAA0B;AACtB,QAAI,CAAC,KAAKoB,OAAL,CAAaxB,EAAb,CAAL,EAAuB;AACnB,WAAKI,IAAL,CAAUJ,EAAV,EAAcmC,SAAd,CAAwB,IAAxB;AACH;AACJ;;AACD,OAAK/B,IAAL,GAAY,KAAKoB,OAAjB;AACH,CARD;AAUA;AACA;AACA;AACA;AAEA;;;AACAJ,CAAC,CAACgB,MAAF,GAAW,YAAY;AACnB,MAAI,CAACjD,MAAM,CAACkD,KAAR,IAAiBlD,MAAM,CAACmD,KAA5B,EAAmC;AAC/B,SAAKC,GAAL;AACH,GAFD,MAEO;AACHjD,WAAO,CAACQ,IAAR,CAAa,IAAb;AACH;AACJ,CAND;AAQA;AACA;AACA;AACA;;;AAEAsB,CAAC,CAACmB,GAAF,GAAQ,YAAY;AAChB,MAAI,KAAKtC,MAAT,EAAiB;AACb,QAAIkB,KAAK,GAAG,KAAKH,GAAL,EAAZ;;AACA,QAAIG,KAAK,KAAK,KAAKA,KAAf,IAAwBqB,KAAK,CAACC,OAAN,CAActB,KAAd,CAAxB,IAAgD,KAAKjB,IAAzD,EAA+D;AAC3D,UAAIwC,QAAQ,GAAG,KAAKvB,KAApB;AACA,WAAKA,KAAL,GAAaA,KAAb;AACA,UAAIpB,GAAG,GAAG,KAAKA,GAAf;;AACA,WAAK,IAAI4C,CAAC,GAAG,CAAR,EAAWC,CAAC,GAAG7C,GAAG,CAAC8C,MAAxB,EAAgCF,CAAC,GAAGC,CAApC,EAAuCD,CAAC,EAAxC,EAA4C;AACxC5C,WAAG,CAAC4C,CAAD,CAAH,CAAOxB,KAAP,EAAcuB,QAAd,EADwC,CAExC;AACA;;AACA,YAAII,OAAO,GAAGF,CAAC,GAAG7C,GAAG,CAAC8C,MAAtB;;AACA,YAAIC,OAAJ,EAAa;AACTH,WAAC,IAAIG,OAAL;AACAF,WAAC,IAAIE,OAAL;AACH;AACJ;AACJ;AACJ;AACJ,CAnBD;AAqBA;AACA;AACA;AACA;AACA;;;AAEA1B,CAAC,CAAC2B,KAAF,GAAU,UAAUpD,EAAV,EAAc;AACpB,OAAKI,GAAL,CAASD,IAAT,CAAcH,EAAd;AACH,CAFD;AAIA;AACA;AACA;AACA;AACA;;;AAEAyB,CAAC,CAAC4B,QAAF,GAAa,UAAUrD,EAAV,EAAc;AACvB,MAAII,GAAG,GAAG,KAAKA,GAAf;;AACA,MAAIA,GAAG,CAAC8C,MAAJ,GAAa,CAAjB,EAAoB;AAChB,QAAIF,CAAC,GAAG5C,GAAG,CAACkD,OAAJ,CAAYtD,EAAZ,CAAR;;AACA,QAAIgD,CAAC,GAAG,CAAC,CAAT,EAAY;AACR5C,SAAG,CAACmD,MAAJ,CAAWP,CAAX,EAAc,CAAd;AACH;AACJ,GALD,MAKO,IAAIhD,EAAE,KAAKI,GAAG,CAAC,CAAD,CAAd,EAAmB;AACtB,SAAKoD,QAAL;AACH;AACJ,CAVD;AAYA;AACA;AACA;;;AAEA/B,CAAC,CAAC+B,QAAF,GAAa,YAAY;AACrB,MAAI,KAAKlD,MAAT,EAAiB;AACb;AACA;AACA;AACA,QAAI,CAAC,KAAKR,EAAL,CAAQ2D,iBAAb,EAAgC;AAC5B,UAAIC,IAAI,GAAG,KAAK5D,EAAL,CAAQI,YAAnB;AACA,UAAI8C,CAAC,GAAGU,IAAI,CAACJ,OAAL,CAAa,IAAb,CAAR;;AACA,UAAIN,CAAC,GAAG,CAAC,CAAT,EAAY;AACRU,YAAI,CAACH,MAAL,CAAYP,CAAZ,EAAe,CAAf;AACH;AACJ;;AACD,SAAK,IAAI3C,EAAT,IAAe,KAAKI,IAApB,EAA0B;AACtB,WAAKA,IAAL,CAAUJ,EAAV,EAAcmC,SAAd,CAAwB,IAAxB;AACH;;AACD,SAAKlC,MAAL,GAAc,KAAd;AACA,SAAKR,EAAL,GAAU,KAAKM,GAAL,GAAW,KAAKoB,KAAL,GAAa,IAAlC;AACH;AACJ,CAlBD;AAoBA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAEA,SAASY,QAAT,CAAkBuB,GAAlB,EAAuB;AACnB,MAAIC,GAAJ,EAASC,GAAT,EAAcb,CAAd;;AACA,OAAKY,GAAL,IAAYD,GAAZ,EAAiB;AACbE,OAAG,GAAGF,GAAG,CAACC,GAAD,CAAT;;AACA,QAAItE,CAAC,CAACwD,OAAF,CAAUe,GAAV,CAAJ,EAAoB;AAChBb,OAAC,GAAGa,GAAG,CAACX,MAAR;;AACA,aAAOF,CAAC,EAAR;AAAYZ,gBAAQ,CAACyB,GAAG,CAACb,CAAD,CAAJ,CAAR;AAAZ;AACH,KAHD,MAGO,IAAI1D,CAAC,CAACwE,QAAF,CAAWD,GAAX,CAAJ,EAAqB;AACxBzB,cAAQ,CAACyB,GAAD,CAAR;AACH;AACJ;AACJ;;AAEDE,MAAM,CAACC,OAAP,GAAiBnE,OAAjB,C;;;;;;;;;;WClQA,oD","file":"main.80203bdeb49484a32e23.hot-update.js","sourcesContent":["var _ = require('./util');\nvar config = require('./config');\nvar Observer = require('./observer');\nvar expParser = require('./parsers/expression');\nvar batcher = require('./batcher');\nvar uid = 0;\n\n/**\n * A watcher parses an expression, collects dependencies,\n * and fires callback when the expression value changes.\n * This is used for both the $watch() api and directives.\n *\n * @param {Vue} vm\n * @param {String} expression\n * @param {Function} cb\n * @param {Object} options\n *                 - {Array} filters\n *                 - {Boolean} twoWay\n *                 - {Boolean} deep\n *                 - {Boolean} user\n * @constructor\n */\n\nfunction Watcher(vm, expression, cb, options) {\n    this.vm = vm;\n    vm._watcherList.push(this);\n    this.expression = expression;\n    this.cbs = [cb];\n    this.id = ++uid; // uid for batching\n    this.active = true;\n    options = options || {};\n    this.deep = !!options.deep;\n    this.user = !!options.user;\n    this.deps = Object.create(null);\n    // setup filters if any.\n    // We delegate directive filters here to the watcher\n    // because they need to be included in the dependency\n    // collection process.\n    if (options.filters) {\n        this.readFilters = options.filters.read;\n        this.writeFilters = options.filters.write;\n    }\n    // parse expression for getter/setter\n    var res = expParser.parse(expression, options.twoWay); //* NOTE: need to read this part\n    this.getter = res.get;\n    this.setter = res.set;\n    this.value = this.get(); //* NOTE: access to observer's get to register as sub\n}\n\nvar p = Watcher.prototype;\n\n/**\n * Add a dependency to this directive.\n *\n * @param {Dep} dep\n */\n\n//* NOTE: why have 2 queues? newDeps and desp??\np.addDep = function (dep) {\n    var id = dep.id;\n    if (!this.newDeps[id]) {\n        this.newDeps[id] = dep;\n        if (!this.deps[id]) {\n            this.deps[id] = dep;\n            dep.addSub(this);\n        }\n    }\n};\n\n/**\n * Evaluate the getter, and re-collect dependencies.\n */\n\np.get = function () {\n    this.beforeGet(); //* NOTE: Observer.target = this;\n    var vm = this.vm;\n    var value;\n    try {\n        value = this.getter.call(vm, vm); //* NOTE: need to understand this line\n    } catch (e) {\n        if (config.warnExpressionErrors) {\n            _.warn(\n                'Error when evaluating expression \"' +\n                    this.expression +\n                    '\":\\n   ' +\n                    e\n            );\n        }\n    }\n    // \"touch\" every property so they are all tracked as\n    // dependencies for deep watching\n    if (this.deep) {\n        traverse(value);\n    }\n    value = _.applyFilters(value, this.readFilters, vm);\n    this.afterGet(); //* NOTE: Observer.target = null;\n    return value;\n};\n\n/**\n * Set the corresponding value with the setter.\n *\n * @param {*} value\n */\n\np.set = function (value) {\n    var vm = this.vm;\n    value = _.applyFilters(value, this.writeFilters, vm, this.value);\n    try {\n        this.setter.call(vm, vm, value);\n    } catch (e) {\n        if (config.warnExpressionErrors) {\n            _.warn(\n                'Error when evaluating setter \"' +\n                    this.expression +\n                    '\":\\n   ' +\n                    e\n            );\n        }\n    }\n};\n\n/**\n * Prepare for dependency collection.\n */\n\np.beforeGet = function () {\n    Observer.target = this;\n    this.newDeps = {};\n};\n\n/**\n * Clean up for dependency collection.\n */\n\np.afterGet = function () {\n    Observer.target = null;\n    for (var id in this.deps) {\n        if (!this.newDeps[id]) {\n            this.deps[id].removeSub(this);\n        }\n    }\n    this.deps = this.newDeps;\n};\n\n/**\n * Subscriber interface.\n * Will be called when a dependency changes.\n */\n\n//* Watcher's update just add watcher instance to batcher array\np.update = function () {\n    if (!config.async || config.debug) {\n        this.run();\n    } else {\n        batcher.push(this);\n    }\n};\n\n/**\n * Batcher job interface.\n * Will be called by the batcher.\n */\n\np.run = function () {\n    if (this.active) {\n        var value = this.get();\n        if (value !== this.value || Array.isArray(value) || this.deep) {\n            var oldValue = this.value;\n            this.value = value;\n            var cbs = this.cbs;\n            for (var i = 0, l = cbs.length; i < l; i++) {\n                cbs[i](value, oldValue);\n                // if a callback also removed other callbacks,\n                // we need to adjust the loop accordingly.\n                var removed = l - cbs.length;\n                if (removed) {\n                    i -= removed;\n                    l -= removed;\n                }\n            }\n        }\n    }\n};\n\n/**\n * Add a callback.\n *\n * @param {Function} cb\n */\n\np.addCb = function (cb) {\n    this.cbs.push(cb);\n};\n\n/**\n * Remove a callback.\n *\n * @param {Function} cb\n */\n\np.removeCb = function (cb) {\n    var cbs = this.cbs;\n    if (cbs.length > 1) {\n        var i = cbs.indexOf(cb);\n        if (i > -1) {\n            cbs.splice(i, 1);\n        }\n    } else if (cb === cbs[0]) {\n        this.teardown();\n    }\n};\n\n/**\n * Remove self from all dependencies' subcriber list.\n */\n\np.teardown = function () {\n    if (this.active) {\n        // remove self from vm's watcher list\n        // we can skip this if the vm if being destroyed\n        // which can improve teardown performance.\n        if (!this.vm._isBeingDestroyed) {\n            var list = this.vm._watcherList;\n            var i = list.indexOf(this);\n            if (i > -1) {\n                list.splice(i, 1);\n            }\n        }\n        for (var id in this.deps) {\n            this.deps[id].removeSub(this);\n        }\n        this.active = false;\n        this.vm = this.cbs = this.value = null;\n    }\n};\n\n/**\n * Recrusively traverse an object to evoke all converted\n * getters, so that every nested property inside the object\n * is collected as a \"deep\" dependency.\n *\n * @param {Object} obj\n */\n\nfunction traverse(obj) {\n    var key, val, i;\n    for (key in obj) {\n        val = obj[key];\n        if (_.isArray(val)) {\n            i = val.length;\n            while (i--) traverse(val[i]);\n        } else if (_.isObject(val)) {\n            traverse(val);\n        }\n    }\n}\n\nmodule.exports = Watcher;\n","__webpack_require__.h = () => \"5cdc8d719f3793ae2ca0\""],"sourceRoot":""}